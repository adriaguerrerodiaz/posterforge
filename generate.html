<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PosterForge - Generate</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <div class="grid-container">
        <div style="grid-column: 1; grid-row: 1;" class="logo-font">PosterForge</div>

        <nav class="normal-text">
            <a href="about.html">About</a>
            <a href="team.html">Team</a>
            <a href="gallery.html">Gallery</a>
            <a href="shop.html" style="margin-left: 40px;">Shop</a>
            <a href="login.html">Log In</a>
        </nav>

        <div style="grid-column: 1; grid-row: 4 / 8;" class="normal-text">
            <p>Genera pòsters únics a partir de dibuixos, il·lustracions i elements gràfics creats per artistes.</p>
            <br>
            <p>Crea la teva pròpia galeria i descarrega o imprimeix els pòsters que més t’agradin.</p>
        </div>

        <div style="grid-column: 3; grid-row: 4 / 13; display: flex; flex-direction: column; gap: 30px;">
            <div class="custom-select-container" onclick="this.classList.toggle('open')">
                <span class="select-label normal-text">Scale</span>
                <div class="select-trigger"><span class="normal-text">Select Scale</span></div>
                <div class="select-options">
                    <div class="option-item normal-text">Horizontal</div>
                    <div class="option-item normal-text" style="border-top: 1px solid #f0f0f0;">Vertical</div>
                </div>
            </div>

            <div class="custom-select-container" onclick="this.classList.toggle('open')">
                <span class="select-label normal-text">Color</span>
                <div class="select-trigger"><span class="normal-text">Select palette</span></div>
                <div class="select-options">
                    <div class="option-item normal-text option-palette" data-palette="sunset">
                        <div class="swatch" style="background: linear-gradient(135deg,#FFB88C 0%,#DE6262 100%);"></div>
                        <span>Sunset</span>
                    </div>
                    <div class="option-item normal-text option-palette" data-palette="ocean">
                        <div class="swatch" style="background: linear-gradient(135deg,#89F7FE 0%,#66A6FF 100%);"></div>
                        <span>Ocean</span>
                    </div>
                    <div class="option-item normal-text option-palette" data-palette="forest">
                        <div class="swatch" style="background: linear-gradient(135deg,#9CECFB 0%,#65C7A6 50%,#0052D4 100%);"></div>
                        <span>Forest</span>
                    </div>
                    <div class="option-item normal-text option-palette" data-palette="mono">
                        <div class="swatch" style="background: linear-gradient(135deg,#F0F0F0 0%,#BFBFBF 100%);"></div>
                        <span>Mono</span>
                    </div>
                </div>
            </div>

            <div class="custom-select-container" onclick="this.classList.toggle('open')">
                <span class="select-label normal-text">Mood</span>
                <div class="select-trigger"><span class="normal-text">Select moods</span></div>
                <div class="select-options">
                    <div class="option-item normal-text">Happy</div>
                    <div class="option-item normal-text">Dark</div>
                    <div class="option-item normal-text">Retro</div>
                </div>
            </div>
        </div>

        <div id="poster-result-container" style="grid-column: 4; grid-row: 4 / 13; display: flex; justify-content: flex-end; align-items: flex-start;">
            </div>

        <div class="controls-row" style="grid-column: 3; grid-row: 15 / 17; display: flex; align-items: center; gap: 15px;">
            <div class="green-counter">5/5</div>
            <button class="forge-button" id="forgeBtn">Forge Your Poster</button>
        </div>
    </div>

    <!-- Saved posters strip -->
    <div id="saved-posters" class="saved-posters" aria-label="Saved posters">
        <div class="no-saved">No hi ha pòsters guardats — genera el primer!</div>
    </div>

    <script>
        // Tanca selectors
        window.onclick = function(event) {
            if (!event.target.closest('.custom-select-container')) {
                document.querySelectorAll('.custom-select-container').forEach(el => el.classList.remove('open'));
            }
        }

        // Logo click
        document.querySelectorAll('.logo-font').forEach(el => {
            el.style.cursor = 'pointer';
            el.onclick = () => window.location.href = 'home.html';
        });

        // Palette selection handling: update trigger text and store selected palette
        document.querySelectorAll('.select-options .option-palette').forEach(opt => {
            opt.addEventListener('click', function(e){
                e.stopPropagation();
                const container = this.closest('.custom-select-container');
                const triggerText = container.querySelector('.select-trigger span');
                triggerText.innerText = this.querySelector('span').innerText;
                container.dataset.palette = this.dataset.palette;

                // mark selected visually
                container.querySelectorAll('.option-palette').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');

                container.classList.remove('open');
            });
        });

        // Generic selection handling for Scale and Mood (saves selection in dataset and marks it)
        document.querySelectorAll('.custom-select-container').forEach(container => {
            const label = container.querySelector('.select-label')?.innerText.trim().toLowerCase();
            // skip color since palette handler manages it
            if (label === 'color') return;
            const triggerSpan = container.querySelector('.select-trigger span');
            container.querySelectorAll('.option-item').forEach(opt => {
                opt.addEventListener('click', function(e){
                    e.stopPropagation();
                    const val = this.innerText.trim();
                    triggerSpan.innerText = val;
                    // store normalized value
                    container.dataset[label] = val.toLowerCase();
                    // mark selected
                    container.querySelectorAll('.option-item').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    container.classList.remove('open');
                });
            });

            // restore selection from dataset if present
            const stored = container.dataset[label];
            if (stored) {
                const match = Array.from(container.querySelectorAll('.option-item')).find(o => o.innerText.trim().toLowerCase() === stored);
                if (match) {
                    match.classList.add('selected');
                    triggerSpan.innerText = match.innerText.trim();
                }
            }
        });

        // Lògica de Generació Combinada
        document.getElementById('forgeBtn').addEventListener('click', function() {
            const container = document.getElementById('poster-result-container');
            const counter = document.querySelector('.green-counter');
            const button = document.getElementById('forgeBtn');

            // Evita generar si el comptador és 0
            let partsCheck = counter.innerText.split('/');
            let currentCheck = parseInt(partsCheck[0]);
            if (currentCheck <= 0) {
                button.innerText = 'Posters diaris esgotats';
                button.disabled = true;
                button.classList.add('disabled');
                return;
            }

            // Llistat de fitxers reals (coincideixen amb els arxius dins d'assets/)
            const llistaDibuixos = ['IMG_4301.JPG', 'IMG_4154.JPG'];
            const llistaGrafics = ['W.svg', 'W&P.svg'];

            const dibuixAleatori = llistaDibuixos[Math.floor(Math.random() * llistaDibuixos.length)];
            const graficAleatori = llistaGrafics[Math.floor(Math.random() * llistaGrafics.length)];

            // Creem el frame del pòster que contindrà les dues capes
            container.innerHTML = `
                <div class="poster-frame">
                    <img src="assets/dibuixos/${dibuixAleatori}" class="layer base-layer" alt="Dibuix" onerror="this.style.display='none'">
                    <img src="assets/gràfics/${graficAleatori}" class="layer top-layer" alt="Gràfic" onerror="this.style.display='none'">
                </div>
            `;

            // Actualitzar comptador
            let parts = counter.innerText.split('/');
            let current = parseInt(parts[0]);
            if (current > 0) {
                current = current - 1;
                counter.innerText = current + "/5";
            }

            // Si arribem a 0, bloqueja el botó
            if (current <= 0) {
                button.innerText = 'Posters diaris esgotats';
                button.disabled = true;
                button.classList.add('disabled');
            }

            // Afegir miniatura al strip de posters guardats
            const saved = document.getElementById('saved-posters');
            const thumb = document.createElement('div');
            thumb.className = 'saved-item';
            thumb.innerHTML = `
                <div class="thumb-frame">
                    <img src="assets/dibuixos/${dibuixAleatori}" alt="thumb base" class="thumb-base" onerror="this.style.display='none'">
                    <img src="assets/gràfics/${graficAleatori}" alt="thumb top" class="thumb-top" onerror="this.style.display='none'">
                </div>
            `;
            // Remove placeholder message if present
            const placeholder = saved.querySelector('.no-saved');
            if (placeholder) placeholder.remove();

            saved.appendChild(thumb);

            // Save poster metadata to localStorage so Gallery can read it
            const paletteContainer = document.querySelector('.custom-select-container[data-palette]');
            const palette = paletteContainer?.dataset.palette || null;
            const scaleContainer = Array.from(document.querySelectorAll('.custom-select-container')).find(c => c.querySelector('.select-label')?.innerText.trim().toLowerCase() === 'scale');
            const moodContainer = Array.from(document.querySelectorAll('.custom-select-container')).find(c => c.querySelector('.select-label')?.innerText.trim().toLowerCase() === 'mood');
            const posterObj = {
                base: `assets/dibuixos/${dibuixAleatori}`,
                top: `assets/gràfics/${graficAleatori}`,
                palette: palette,
                scale: scaleContainer?.dataset.scale || null,
                mood: moodContainer?.dataset.mood || null,
                created: Date.now()
            };
            savePosterToStorage(posterObj);

            // Mantén el strip amb el últim element visible
            saved.scrollLeft = saved.scrollWidth;
        });

        // Disable button on load if quota already exhausted
        (function(){
            const initCounter = document.querySelector('.green-counter');
            if (initCounter && parseInt(initCounter.innerText.split('/')[0]) <= 0) {
                const btn = document.getElementById('forgeBtn');
                btn.innerText = 'Posters diaris esgotats';
                btn.disabled = true;
                btn.classList.add('disabled');
            }

            // Load saved posters into the bottom strip on page load
            loadSavedPostersToStrip();
        })();

        // Save poster metadata to localStorage and notify other pages
        function savePosterToStorage(obj) {
            try {
                const key = 'posterforge_saved';
                const arr = JSON.parse(localStorage.getItem(key) || '[]');
                arr.push(obj);
                localStorage.setItem(key, JSON.stringify(arr));
                // dispatch custom event for same-tab listeners
                window.dispatchEvent(new Event('posterforge:updated'));
            } catch (e) {
                console.error('Failed to save poster to storage', e);
            }
        }

        // Populate the saved-posters strip from localStorage
        function loadSavedPostersToStrip() {
            const key = 'posterforge_saved';
            const arr = JSON.parse(localStorage.getItem(key) || '[]');
            const saved = document.getElementById('saved-posters');
            saved.innerHTML = '';
            if (!arr || arr.length === 0) {
                saved.innerHTML = '<div class="no-saved">No hi ha pòsters guardats — genera el primer!</div>';
                return;
            }
            arr.forEach(p => {
                const thumb = document.createElement('div');
                thumb.className = 'saved-item';
                thumb.innerHTML = `
                    <div class="thumb-frame">
                        <img src="${p.base}" alt="thumb base" class="thumb-base" onerror="this.style.display='none'">
                        <img src="${p.top}" alt="thumb top" class="thumb-top" onerror="this.style.display='none'">
                    </div>
                `;
                saved.appendChild(thumb);
            });
            saved.scrollLeft = saved.scrollWidth;
        }

        // Listen for storage changes (other tabs) and custom event (same tab)
        window.addEventListener('storage', loadSavedPostersToStrip);
        window.addEventListener('posterforge:updated', loadSavedPostersToStrip);
    </script>
</body>
</html>